#!/bin/bash
set -e

pushd "$(dirname "$0")" >/dev/null
JOBINDIR=$(pwd)
JOLIBDIR=$JOBINDIR/.jo
JOROOT=$(dirname "$JOBINDIR")
popd >/dev/null

export NODE_PATH="${JOROOT}/jo/node_modules"

if [ "$1" == "--force" ]; then
  rm -rf "$JOLIBDIR"
  mkdir -p "$JOLIBDIR"
elif [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
  echo "Usage: $0 [--force]" >&2
  exit 0
else
  mkdir -p "$JOLIBDIR/visitors"
fi

# Really messy paths here: only way to make sourcemap paths work properly with babel & node

pushd "${JOROOT}" >/dev/null
mkdir -p "$JOLIBDIR/.build"
for pkg in . util transformers remotectrl asyncfs; do
  dstf=$JOLIBDIR/$pkg/index.js
  mkdir -p "$JOLIBDIR/$pkg"

  for srcf in "jo/$pkg"/*.js; do
    # echo "check mtime $srcf"
    if [ "$srcf" -nt "$dstf" ]; then
      pushd "$JOLIBDIR/.build" >/dev/null
      if [ "$pkg" == "." ]; then
        out=$JOLIBDIR/index.js
      else
        out=$JOLIBDIR/$pkg/index.js
      fi
      echo "$0: building $pkg"
      # echo "pwd: '$(pwd)'"
      # echo "in:  '../../../jo/$pkg/*.js'"
      # echo "out: '$out'"
      "${NODE_PATH}/babel/bin/babel/index.js" \
        --source-maps \
        --modules common \
        --experimental \
        --optional es6.symbols,runtime \
        --out-file "$out" \
        "../../../jo/$pkg"/*.js
        # --compact true

      if [ "$pkg" == "." ]; then
        tmpout=$JOLIBDIR/$pkg/.tmp.index.js
        mv "$out" "$tmpout"
        echo -n "require('source-map-support').install({" >> "$out"
        echo -n   "retrieveSourceMap: function(source) {" >> "$out"
        echo -n     "if (source.indexOf('/.jo/') !== -1) {" >> "$out"
        echo -n       "return { url: source, map: require('fs').readFileSync(source+'.map', 'utf8') };" >> "$out"
        echo -n     "}" >> "$out"
        echo -n   "}" >> "$out"
        echo "});" >> "$out"
        cat "$tmpout" >> "$out"
        echo '' >> "$out"  # make sure there's a line break at the end
        echo "main(process.argv);" >> "$out"
        rm "$tmpout"
      fi

      popd >/dev/null
      break
    fi
  done
done
popd >/dev/null
